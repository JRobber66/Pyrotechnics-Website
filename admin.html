<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }
    h2 {
      margin-top: 30px;
    }
    .section {
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }
    button {
      padding: 5px 10px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <div class="section">
    <h2>Active Users</h2>
    <table id="userTable">
      <thead>
        <tr><th>Username</th><th>Display Name</th><th>IP</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Bans</h2>
    <ul id="banList"></ul>
  </div>

  <div class="section">
    <h2>Logs</h2>
    <pre id="logBox" style="background:#fff; padding:10px; height:200px; overflow:auto;"></pre>
    <button onclick="refreshLog()">Refresh Logs</button>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const displayName = localStorage.getItem("displayName");
    const httpBackend = "https://backend-test-je8a.onrender.com";

    // Protect dashboard
    if (!token || displayName !== "Administrator") {
      alert("Access denied.");
      location.href = "login.html";
    }

    // Fetch users/bans for table
    async function fetchDashboard() {
      const res = await fetch(httpBackend + "/admin-state", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      renderUsers(data.users);
      renderBans(data.bans);
    }

    function renderUsers(users) {
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";
      users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.displayName}</td>
          <td>${u.ip}</td>
          <td>
            <button onclick="ban('${u.displayName}')">Ban</button>
            <button onclick="unban('${u.displayName}')">Unban</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function renderBans(bans) {
      const ul = document.getElementById("banList");
      ul.innerHTML = "";
      bans.forEach(b => {
        const li = document.createElement("li");
        li.textContent = b;
        ul.appendChild(li);
      });
    }

    // Send a slash-command over WebSocket and wait until sent
    function sendCommand(cmd) {
      return new Promise((resolve, reject) => {
        const ws = new WebSocket("wss://backend-test-je8a.onrender.com");
        ws.onopen = () => {
          ws.send(cmd);
          ws.close();
          resolve();
        };
        ws.onerror = err => reject(err);
      });
    }

    // Ban and unban actions
    async function ban(name) {
      await sendCommand(`/ban ${name}`);
      await fetchDashboard();
    }
    async function unban(name) {
      await sendCommand(`/unban ${name}`);
      await fetchDashboard();
    }

    // Refresh the message log display
    async function refreshLog() {
      const res = await fetch(httpBackend + "/admin-log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      document.getElementById("logBox").textContent = data.log || "(no log)";
    }

    // Initial load
    fetchDashboard();
  </script>
</body>
</html>
