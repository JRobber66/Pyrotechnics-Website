<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }
    button {
      padding: 6px 12px;
      margin-right: 8px;
      margin-bottom: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #backBtn { background: #007bff; color: white; }
    #clearAccountsBtn { background: #dc3545; color: white; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-bottom: 20px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    h2 { margin-top: 30px; }
    pre {
      background: white;
      padding: 10px;
      height: 200px;
      overflow: auto;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <button id="backBtn" onclick="location.href='chat.html'">Back to Chat</button>
  <button id="clearAccountsBtn" onclick="clearAccounts()">Clear Accounts</button>

  <h1>Admin Dashboard</h1>

  <div>
    <h2>Active Users</h2>
    <table id="userTable">
      <thead><tr><th>Username</th><th>Display Name</th><th>IP</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div>
    <h2>Bans</h2>
    <ul id="banList"></ul>
  </div>

  <div>
    <h2>Logs</h2>
    <pre id="logBox">(loading...)</pre>
    <button onclick="refreshLog()">Refresh Logs</button>
  </div>

  <script>
    const HTTP_URL = "https://backend-test-je8a.onrender.com";
    const token     = localStorage.getItem("token");
    const displayName = localStorage.getItem("displayName");
    if (!token || displayName !== "Administrator") {
      alert("Access denied.");
      location.href = "login.html";
    }

    async function fetchDashboard() {
      const res = await fetch(HTTP_URL + "/admin-state", {
        method: "POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      renderUsers(data.users);
      renderBans(data.bans);
    }

    function renderUsers(users) {
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";
      users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.displayName}</td>
          <td>${u.ip}</td>
          <td>
            <button onclick="ban('${u.displayName}')">Ban</button>
            <button onclick="unban('${u.displayName}')">Unban</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function renderBans(bans) {
      const ul = document.getElementById("banList");
      ul.innerHTML = "";
      bans.forEach(b => {
        const li = document.createElement("li");
        li.textContent = b;
        ul.appendChild(li);
      });
    }

    function sendCommand(cmd) {
      return new Promise((resolve, reject) => {
        const ws = new WebSocket("wss://backend-test-je8a.onrender.com");
        ws.onopen = () => { ws.send(cmd); ws.close(); resolve(); };
        ws.onerror = err => reject(err);
      });
    }

    async function ban(name) {
      await sendCommand(`/ban ${name}`);
      await fetchDashboard();
    }
    async function unban(name) {
      await sendCommand(`/unban ${name}`);
      await fetchDashboard();
    }
    async function clearAccounts() {
      await sendCommand(`/clear-accounts`);
      await fetchDashboard();
    }

    async function refreshLog() {
      const res = await fetch(HTTP_URL + "/admin-log", {
        method: "POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      document.getElementById("logBox").textContent = data.log || "(no log)";
    }

    fetchDashboard();
    refreshLog();
  </script>
</body>
</html>
